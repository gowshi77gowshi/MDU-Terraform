trigger:
  branches:
    include:
      - main

# ========================== PARAMETERS ==========================
parameters:
  - name: project
    displayName: "Project Name"
    type: string
    default: "Mdu"

  - name: environment
    displayName: "Deployment Environment"
    type: string
    default: "dev"
    values:
      - dev
      - stg
      - prod

  - name: location
    displayName: "Azure Region"
    type: string
    default: "uksouth"
    values:
      - uksouth
      - eastus
      - westeurope

  - name: instance
    displayName: "Instance Number"
    type: string
    default: "001"

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: mdu-terraform   # Reference variable group from Library

- name: TF_STORAGE_ACCOUNT
  value: "storageaccountmdu001"

- name: TF_CONTAINER_NAME
  value: "mdu-statefile"

- name: TF_STATE_FILE
  value: "terraform.tfstate"

- name: TF_RESOURCE_GROUP
  value: "rg-mdu-dev-001"

stages:

# ========================== INIT + VALIDATE + PLAN ==========================
- stage: Terraform_CI
  displayName: "Terraform Init, Validate & Plan"
  jobs:
    - job: Plan
      steps:
        - checkout: self

        # 1. Fetch Key Vault Secrets
        - task: AzureKeyVault@2
          name: FetchSecrets
          inputs:
            azureSubscription: 'mdu-conn'
            KeyVaultName: 'kv-${{ parameters.project }}-${{ parameters.environment }}-${{ parameters.location }}-${{ parameters.instance }}'
            SecretsFilter: '*'
            RunAsPreJob: true

        # 2. Generate terraform.tfvars dynamically
        - bash: |
            echo "project     = \"${{ parameters.project }}\""   > terraform.tfvars
            echo "environment = \"${{ parameters.environment }}\"" >> terraform.tfvars
            echo "location    = \"${{ parameters.location }}\""    >> terraform.tfvars
            echo "instance    = \"${{ parameters.instance }}\""    >> terraform.tfvars

            # Merge Key Vault secrets (exclude system variables)
            for secret in $(compgen -A variable); do
              if [[ "$secret" =~ ^(TF_|BUILD_|SYSTEM_|AGENT_|COMP_|IFS|PWD|HOME|USER|SHELL|PATH) ]]; then
                continue
              fi

              fixed_name=$(echo "$secret" | tr '-' '_')
              value=$(echo -n "${!secret}" | tr -d '\r' | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g')
              echo "${fixed_name} = \"${value}\"" >> terraform.tfvars
            done

            echo "=========== Final terraform.tfvars ==========="
            cat terraform.tfvars
          displayName: "Generate terraform.tfvars"

        # 3. Install Terraform CLI
        - task: TerraformInstaller@1
          displayName: "Install Terraform CLI"
          inputs:
            terraformVersion: 'latest'

        # 4. Initialize Terraform backend using Azure Storage
        - task: TerraformTaskV4@4
          displayName: "Terraform Init"
          inputs:
            provider: 'azurerm'
            command: 'init'
            backendServiceArm: 'mdu-conn'
            backendAzureRmResourceGroupName: 'rg-mdu-dev-001'
            backendAzureRmStorageAccountName: 'storageaccountmdu001'
            backendAzureRmContainerName: 'mdu-statefile'
            backendAzureRmKey: 'terraform.tfstate'

        # 5. Validate Terraform configuration
        - task: TerraformTaskV4@4
          displayName: "Terraform Validate"
          inputs:
            provider: 'azurerm'
            command: 'validate'

        # 6. Run Terraform Plan using merged tfvars
        - script: |
            terraform plan \
              -var-file=terraform.tfvars \
              -var-file=terraform.tfvars \
              -out=tfplan
          displayName: "Terraform Plan"

        # 7. Publish plan artifact for Apply stage
        - publish: $(System.DefaultWorkingDirectory)/tfplan
          artifact: terraform-plan
          displayName: "Publish Terraform Plan Artifact"

# ========================== APPLY (with Approval) ==========================
- stage: Terraform_Apply
  displayName: "Terraform Apply"
  dependsOn: Terraform_CI
  condition: succeeded('Terraform_CI')
  jobs:
    - deployment: Apply
      environment: ${{ parameters.environment }}
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self

              # Download plan artifact
              - download: current
                artifact: terraform-plan
                displayName: "Download Terraform Plan"

              # Install Terraform
              - task: TerraformInstaller@1
                displayName: "Install Terraform CLI"
                inputs:
                  terraformVersion: 'latest'

              # Re-run Terraform Init
              - task: TerraformTaskV4@4
                displayName: "Terraform Init"
                inputs:
                  provider: 'azurerm'
                  command: 'init'
                  backendServiceArm: 'mdu-conn'
                  backendAzureRmResourceGroupName: 'rg-mdu-dev-001'
                  backendAzureRmStorageAccountName: 'storageaccountmdu001'
                  backendAzureRmContainerName: 'mdu-statefile'
                  backendAzureRmKey: 'terraform.tfstate'

              # Apply using saved plan
              - script: terraform apply -auto-approve $(Pipeline.Workspace)/terraform-plan/tfplan
                displayName: "Terraform Apply"

# ========================== DESTROY (with Approval) ==========================
- stage: Terraform_Destroy
  displayName: "Terraform Destroy"
  dependsOn: Terraform_Apply
  condition: succeeded('Terraform_Apply')
  jobs:
    - deployment: Destroy
      environment: ${{ parameters.environment }}
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self

              # Install Terraform
              - task: TerraformInstaller@1
                displayName: "Install Terraform CLI"
                inputs:
                  terraformVersion: 'latest'

              # Re-run Terraform Init
              - task: TerraformTaskV4@4
                displayName: "Terraform Init"
                inputs:
                  provider: 'azurerm'
                  command: 'init'
                  backendServiceArm: 'mdu-conn'
                  backendAzureRmResourceGroupName: 'rg-mdu-dev-001'
                  backendAzureRmStorageAccountName: 'storageaccountmdu001'
                  backendAzureRmContainerName: 'mdu-statefile'
                  backendAzureRmKey: 'terraform.tfstate'

              # Destroy resources using merged tfvars
              - script: |
                  terraform destroy \
                    -var-file=terraform.tfvars \
                    -var-file=terraform.tfvars \
                    -auto-approve
                displayName: "Terraform Destroy"
























# trigger:
#   branches:
#     include:
#       - main

# # ========================== PARAMETERS ==========================
# parameters:
#   - name: environment
#     displayName: "Deployment Environment"
#     type: string
#     default: "dev"
#     values:
#       - dev
#       - stg
#       - prod

#   - name: location
#     displayName: "Azure Region"
#     type: string
#     default: "uksouth"
#     values:
#       - uksouth
#       - eastus
#       - westeurope

# pool:
#   vmImage: 'ubuntu-latest'

# variables:
#   TF_STORAGE_ACCOUNT: "storageaccountmdu001"
#   TF_CONTAINER_NAME: "mdu-statefile"
#   TF_STATE_FILE: "terraform.tfstate"
#   TF_RESOURCE_GROUP: "rg-mdu-dev-001"

# stages:

# # ========================== INIT + VALIDATE + PLAN ==========================
# - stage: Terraform_CI
#   displayName: "Terraform Init, Validate & Plan"
#   jobs:
#     - job: Plan
#       steps:
#         - checkout: self

#         # Install Terraform CLI
#         - task: TerraformInstaller@1
#           displayName: "Install Terraform CLI"
#           inputs:
#             terraformVersion: 'latest'

#         # Initialize Terraform backend using Azure Storage
#         - task: TerraformTaskV4@4
#           displayName: "Terraform Init"
#           inputs:
#             provider: 'azurerm'
#             command: 'init'
#             backendServiceArm: 'mdu-conn'
#             backendAzureRmResourceGroupName: 'rg-mdu-dev-001'
#             backendAzureRmStorageAccountName: 'storageaccountmdu001'
#             backendAzureRmContainerName: 'mdu-statefile'
#             backendAzureRmKey: 'terraform.tfstate'

#         # Validate Terraform configuration
#         - task: TerraformTaskV4@4
#           displayName: "Terraform Validate"
#           inputs:
#             provider: 'azurerm'
#             command: 'validate'

#         # Run Terraform Plan and save plan file
#         - task: TerraformTaskV4@4
#           displayName: "Terraform Plan"
#           inputs:
#             provider: 'azurerm'
#             command: 'plan'
#             commandOptions: >
#               -var "environment=${{ parameters.environment }}"
#               -var "location=${{ parameters.location }}"
#               -out=tfplan
#             environmentServiceNameAzureRM: 'mdu-conn'

#         # Publish plan artifact for Apply stage
#         - publish: $(System.DefaultWorkingDirectory)/tfplan
#           artifact: terraform-plan
#           displayName: "Publish Terraform Plan Artifact"

# # ========================== APPLY (with Approval) ==========================
# - stage: Terraform_Apply
#   displayName: "Terraform Apply"
#   dependsOn: Terraform_CI
#   condition: succeeded('Terraform_CI')
#   jobs:
#     - deployment: Apply
#       environment: ${{ parameters.environment }} # manual approvals via Environment
#       strategy:
#         runOnce:
#           deploy:
#             steps:
#               - checkout: self

#               # Download plan artifact
#               - download: current
#                 artifact: terraform-plan
#                 displayName: "Download Terraform Plan"

#               # Install Terraform
#               - task: TerraformInstaller@1
#                 displayName: "Install Terraform CLI"
#                 inputs:
#                   terraformVersion: 'latest'

#               # Re-run Terraform Init (modules & providers download)
#               - task: TerraformTaskV4@4
#                 displayName: "Terraform Init"
#                 inputs:
#                   provider: 'azurerm'
#                   command: 'init'
#                   backendServiceArm: 'mdu-conn'
#                   backendAzureRmResourceGroupName: 'rg-mdu-dev-001'
#                   backendAzureRmStorageAccountName: 'storageaccountmdu001'
#                   backendAzureRmContainerName: 'mdu-statefile'
#                   backendAzureRmKey: 'terraform.tfstate'

#               # Apply using the saved tfplan
#               - task: TerraformTaskV4@4
#                 displayName: "Terraform Apply"
#                 inputs:
#                   provider: 'azurerm'
#                   command: 'apply'
#                   commandOptions: '-auto-approve $(Pipeline.Workspace)/terraform-plan/tfplan'
#                   environmentServiceNameAzureRM: 'mdu-conn'

# # ========================== DESTROY (with Approval) ==========================
# - stage: Terraform_Destroy
#   displayName: "Terraform Destroy"
#   dependsOn: Terraform_Apply
#   condition: succeeded('Terraform_Apply')
#   jobs:
#     - deployment: Destroy
#       environment: ${{ parameters.environment }} # manual approvals again
#       strategy:
#         runOnce:
#           deploy:
#             steps:
#               - checkout: self

#               # Install Terraform
#               - task: TerraformInstaller@1
#                 displayName: "Install Terraform CLI"
#                 inputs:
#                   terraformVersion: 'latest'

#               # Re-run Terraform Init
#               - task: TerraformTaskV4@4
#                 displayName: "Terraform Init"
#                 inputs:
#                   provider: 'azurerm'
#                   command: 'init'
#                   backendServiceArm: 'mdu-conn'
#                   backendAzureRmResourceGroupName: 'rg-mdu-dev-001'
#                   backendAzureRmStorageAccountName: 'storageaccountmdu001'
#                   backendAzureRmContainerName: 'mdu-statefile'
#                   backendAzureRmKey: 'terraform.tfstate'

#               # Destroy resources
#               - task: TerraformTaskV4@4
#                 displayName: "Terraform Destroy"
#                 inputs:
#                   provider: 'azurerm'
#                   command: 'destroy'
#                   commandOptions: >
#                     -var "environment=${{ parameters.environment }}"
#                     -var "location=${{ parameters.location }}"
#                     -auto-approve
#                   environmentServiceNameAzureRM: 'mdu-conn'
























# trigger:
#   branches:
#     include:
#       - main

# # ========================== PARAMETERS ==========================
# parameters:
#   - name: environment
#     displayName: "Deployment Environment"
#     type: string
#     default: "dev"
#     values:
#       - dev
#       - stg
#       - prod

#   - name: location
#     displayName: "Azure Region"
#     type: string
#     default: "uksouth"
#     values:
#       - uksouth
#       - eastus
#       - westeurope

# pool:
#   vmImage: 'ubuntu-latest'

# variables:
#   TF_STORAGE_ACCOUNT: "storageaccountmdu001"
#   TF_CONTAINER_NAME: "mdu-statefile"
#   TF_STATE_FILE: "terraform.tfstate"
#   TF_RESOURCE_GROUP: "rg-mdu-dev-001"

# stages:

# # ========================== INIT + VALIDATE + PLAN ==========================
# - stage: Terraform_CI
#   displayName: "Terraform Init, Validate & Plan"
#   jobs:
#     - job: Plan
#       steps:
#         # Install Terraform CLI
#         - checkout: self
#         - task: TerraformInstaller@1
#           displayName: "Install Terraform CLI"
#           inputs:
#             terraformVersion: 'latest'

#         # Initialize Terraform backend using Azure Storage
#         - task: TerraformTaskV4@4
#           displayName: "Terraform Init"
#           inputs:
#             provider: 'azurerm'
#             command: 'init'
#             backendServiceArm: 'mdu-conn'
#             backendAzureRmResourceGroupName: 'rg-mdu-dev-001'
#             backendAzureRmStorageAccountName: 'storageaccountmdu001'
#             backendAzureRmContainerName: 'mdu-statefile'
#             backendAzureRmKey: 'terraform.tfstate'

#         # Validate Terraform configuration syntax
#         - task: TerraformTaskV4@4
#           displayName: "Terraform Validate"
#           inputs:
#             provider: 'azurerm'
#             command: 'validate'

#         # Run Terraform Plan and save plan file
#         - task: TerraformTaskV4@4
#           displayName: "Terraform Plan"
#           inputs:
#             provider: 'azurerm'
#             command: 'plan'
#             commandOptions: >
#               -var "environment=${{ parameters.environment }}"
#               -var "location=${{ parameters.location }}"
#               -out=tfplan
#             environmentServiceNameAzureRM: 'mdu-conn'

#         # Publish the plan file as artifact for next stage
#         - publish: $(System.DefaultWorkingDirectory)/tfplan
#           artifact: terraform-plan
#           displayName: "Publish Terraform Plan Artifact"

# # ========================== APPLY (with Approval) ==========================
# - stage: Terraform_Apply
#   displayName: "Terraform Apply"
#   dependsOn: Terraform_CI
#   condition: succeeded('Terraform_CI')
#   jobs:
#     - deployment: Apply
#       # Environment enforces manual approval (Dev, Stg, Prod configured in Azure DevOps)
#       environment: ${{ parameters.environment }}
#       strategy:
#         runOnce:
#           deploy:
#             steps:
#               - checkout: self
#               # Download the approved plan from previous stage
#               - download: current
#                 artifact: terraform-plan
#                 displayName: "Download Terraform Plan"

#               # Install Terraform (needed for apply)
#               - task: TerraformInstaller@1
#                 displayName: "Install Terraform CLI"
#                 inputs:
#                   terraformVersion: 'latest'

#               # Apply the plan (use only tfplan, do not re-run variables)
#               - task: TerraformTaskV4@4
#                 displayName: "Terraform Apply"
#                 inputs:
#                   provider: 'azurerm'
#                   command: 'apply'
#                   commandOptions: '-auto-approve $(Pipeline.Workspace)/terraform-plan/tfplan'
#                   environmentServiceNameAzureRM: 'mdu-conn'

# # ========================== DESTROY (with Approval) ==========================
# - stage: Terraform_Destroy
#   displayName: "Terraform Destroy"
#   dependsOn: Terraform_Apply
#   condition: succeeded('Terraform_Apply')
#   jobs:
#     - deployment: Destroy
#       # Environment again enforces approvals
#       environment: ${{ parameters.environment }}
#       strategy:
#         runOnce:
#           deploy:
#             steps:
#               # Install Terraform for destroy
#               - task: TerraformInstaller@1
#                 displayName: "Install Terraform CLI"
#                 inputs:
#                   terraformVersion: 'latest'

#               # Destroy resources with variables and auto-approve
#               - task: TerraformTaskV4@4
#                 displayName: "Terraform Destroy"
#                 inputs:
#                   provider: 'azurerm'
#                   command: 'destroy'
#                   commandOptions: >
#                     -var "environment=${{ parameters.environment }}"
#                     -var "location=${{ parameters.location }}"
#                     -auto-approve
#                   environmentServiceNameAzureRM: 'mdu-conn'
















# trigger:
#   branches:
#     include:
#       - main

# # ========================== PARAMETERS ==========================
# parameters:
#   - name: environment
#     displayName: "Deployment Environment"
#     type: string
#     default: "dev"
#     values:
#       - dev
#       - stg
#       - prod

#   - name: location
#     displayName: "Azure Region"
#     type: string
#     default: "uksouth"
#     values:
#       - uksouth
#       - eastus
#       - westeurope

# pool:
#   vmImage: 'ubuntu-latest'

# variables:
#   TF_STORAGE_ACCOUNT: "storageaccountmdu001"
#   TF_CONTAINER_NAME: "mdu-statefile"
#   TF_STATE_FILE: "terraform.tfstate"
#   TF_RESOURCE_GROUP: "rg-mdu-dev-001"

# stages:

# # ========================== INIT ==========================
# - stage: Terraform_CI
#   displayName: "Terraform Init"
#   jobs:
#     - job: Init
#       steps:
#         # Install Terraform CLI
#         - task: TerraformInstaller@1
#           displayName: "Install Terraform CLI"
#           inputs:
#             terraformVersion: 'latest'

#         # Initialize Terraform backend using Azure Storage
#         - task: TerraformTaskV4@4
#           displayName: "Terraform Init"
#           inputs:
#             provider: 'azurerm'
#             command: 'init'
#             backendServiceArm: 'mdu-conn'
#             backendAzureRmResourceGroupName: 'rg-mdu-dev-001'
#             backendAzureRmStorageAccountName: 'storageaccountmdu001'
#             backendAzureRmContainerName: 'mdu-statefile'
#             backendAzureRmKey: 'terraform.tfstate'
# # ========================== VALIDATE ==========================
#         - task: TerraformTaskV4@4
#           displayName: "Terraform Validate"
#           inputs:
#             provider: 'azurerm'
#             command: 'validate'

# # ========================== PLAN ==========================
#         # Run Terraform Plan with dynamic environment & location variables
#         - task: TerraformTaskV4@4
#           displayName: "Terraform Plan"
#           inputs:
#             provider: 'azurerm'
#             command: 'plan'
#             commandOptions: >
#               -var "environment=${{ parameters.environment }}"
#               -var "location=${{ parameters.location }}"
#               -out=tfplan
#             environmentServiceNameAzureRM: 'mdu-conn'

#         # Publish the plan file as an artifact for Apply stage
#         - publish: $(System.DefaultWorkingDirectory)/tfplan
#           artifact: terraform-plan
#           displayName: "Publish Terraform Plan Artifact"

# # ========================== APPLY (with Approval) ==========================
# - stage: Terraform_Apply
#   displayName: "Terraform Apply"
#   dependsOn: Terraform_CI
#   condition: succeeded('Terraform_CI')
#   jobs:
#     - deployment: Apply
#       # Attach to the environment (dev/stg/prod) - Approvals configured in Azure DevOps
#       environment: ${{ parameters.environment }}
#       strategy:
#         runOnce:
#           deploy:
#             steps:
#               # Download the plan artifact from Plan stage
#               - download: current
#                 artifact: terraform-plan
#                 displayName: "Download Terraform Plan"

#               # Apply the Terraform plan (no changes allowed since plan was approved)
#               - task: TerraformInstaller@1
#                 inputs:
#                   terraformVersion: 'latest'
#               - task: TerraformTaskV4@4
#                 displayName: "Terraform Apply"
#                 inputs:
#                   provider: 'azurerm'
#                   command: 'apply'
#                   commandOptions: >
#                     -var "environment=${{ parameters.environment }}"
#                     -var "location=${{ parameters.location }}"
#                     -out=tfplan
#                   environmentServiceNameAzureRM: 'mdu-conn'

# # ========================== DESTROY (with Approval) ==========================
# - stage: Terraform_Destroy
#   displayName: "Terraform Destroy"
#   dependsOn: Terraform_Apply
#   condition: succeeded('Terraform_Apply')
#   jobs:
#     - deployment: Destroy
#       # Attach to environment to enforce approvals again
#       environment: ${{ parameters.environment }}
#       strategy:
#         runOnce:
#           deploy:
#             steps:
#               # Destroy resources with same variables
#               - task: TerraformTaskV4@4
#                 displayName: "Terraform Destroy"
#                 inputs:
#                   provider: 'azurerm'
#                   command: 'destroy'
#                   commandOptions: >
#                     -var "environment=${{ parameters.environment }}"
#                     -var "location=${{ parameters.location }}"
#                     -auto-approve
#                   environmentServiceNameAzureRM: 'mdu-conn'
